pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
--level manager

levels={}
current_lvl_name='game'
message=''
	
function _init()
	poke(0x5f2d,1)
	init_game_lvl()
	init_frames()
	init_numbers()
	init_collection_level()
end

function _update60()
	local current=get_current_lvl()
	
	if current and current.update then
		current.update()
	end
	
	update_mouse()
end

function _draw()
	cls()
	local current=get_current_lvl()
	
	if current and current.draw then
		current.draw()
	end
	
	draw_mouse()
	print(message,0,0)
end

function add_level(lvl)
	add(levels,lvl)
end

function get_current_lvl()
	for lvl in all(levels) do
		if lvl.name == current_lvl_name then
			return lvl
		end
	end
	
	return nil
end

-->8
--game level

current_card={}
just_click=false

function init_game_lvl()
	add_level({
		name='game',
		update=update_game,
		draw=draw_game
	})
	
	current_card=get_rnd_card()
end

function update_game()
	if (stat(34) == 1 and not just_click) then
		current_card=get_rnd_card()
		just_click=true
	end
	
	if (stat(34) ~= 1) then
		just_click=false
	end
end

function draw_game()
	print('click pour generer une carte')
	print('')
	print('rarete des cadres :')
	print('  bronze < silver < gold')
	print('')
	print('plus le chiffre est grand,')
	print('plus il est rare')

 if current_card.frame then
		draw_card(60,59,current_card)
 end
end
-->8
--numbers

numbers={}

function init_numbers()
	add(numbers,❎1)
	add(numbers,❎2)
	add(numbers,❎3)
	add(numbers,❎4)
	add(numbers,❎5)
	add(numbers,❎6)
	add(numbers,❎7)
	add(numbers,❎8)
	add(numbers,❎9)
	add(numbers,❎0)
end

❎1={sx=0,sy=0,sw=5,sh=7}
❎2={sx=6,sy=0,sw=5,sh=7}
❎3={sx=12,sy=0,sw=5,sh=7}
❎4={sx=18,sy=0,sw=5,sh=7}
❎5={sx=24,sy=0,sw=5,sh=7}
❎6={sx=30,sy=0,sw=5,sh=7}
❎7={sx=36,sy=0,sw=5,sh=7}
❎8={sx=42,sy=0,sw=5,sh=7}
❎9={sx=48,sy=0,sw=5,sh=7}
❎0={sx=54,sy=0,sw=5,sh=7}
❎qm={sx=60,sy=0,sw=5,sh=7}

function draw_number(x,y,num,col)
	pal(7,col)
	sspr(
		num.sx,
		num.sy,
		num.sw,
		num.sh,
		x,
		y
	)
	pal()
end
-->8
--cards

function draw_card(x,y,card)
	sspr(
		card.frame.sx,
		card.frame.sy,
		card.frame.sw,
		card.frame.sh,
		x,
		y
	)
	
	draw_number(
		x+2,
		y+3,
		card.number,
		card.frame.col
	)
end

function get_rnd_card()
	local frame_idx=get_rnd_in_table(frames)
	local number_idx=get_rnd_in_table(numbers)
	
	local frame=frames[frame_idx]
	local number=numbers[number_idx]

	--message='frame: '..frame_idx..' num: '..number_idx
	return {frame=frame,number=number}
end

function get_rnd_in_table(table)
	local result=0
	
	for i=1, #table do
		local random=ceil(rnd(2)) - 1
		if random == 0 then
			result=i
			break
		end
		
		if i == #table then
			result=i
		end
	end
	
	return result
end
-->8
--frames

frames={}

function init_frames()
	add(frames,bronze)
	add(frames,silver)
	add(frames,gold)
end

bronze={sx=0,sy=8,sw=9,sh=13,col=9}
silver={sx=10,sy=8,sw=9,sh=13,col=6}
gold={sx=20,sy=8,sw=9,sh=13,col=10}
-->8
--collection

collection={}

function init_collection_level()
	add_level({
		name='collection',
		update=update_collection,
		draw=draw_collection
	})
end

function update_collection()
	if btnp(❎) then
		add_card_to_collection(get_rnd_card())	
	end
end

function draw_collection()
	local x_index=0
	local y_index=0
	local card_width=10
	local card_height=8
	
	for card in all(collection) do
		draw_card(
			x_index*card_width,
			y_index*card_height,
			card
		)
		
		x_index += 1
	end
end

function add_card_to_collection(card)
	add(collection,card)
end
-->8
--mouse

mouse_x=0
mouse_y=0

function update_mouse()
	mouse_x=stat(32)
	mouse_y=stat(33)
end

function draw_mouse()
	spr(48,mouse_x,mouse_y)
end

function get_clicked_element(elements)
	for element in all(elements) do
		if (
			mouse_x > element.x and
			mouse_x < element.x + element.w and
			mouse_y > element.y and
			mouse_y < element.y + element.h
		) then
			return element
		end
	end
	
	return nil
end
__gfx__
00700807770807770800077877777800770877777807770807770807770807770800000000000000000000000000000000000000000000000000000000000000
07700870007870007800707870000807000800007870007870007870007870007800000000000000000000000000000000000000000000000000000000000000
00700800007800007807007877770870000800070870007870007870077800007800000000000000000000000000000000000000000000000000000000000000
00700800770807770870007800007877770800700807770807777870707800070800000000000000000000000000000000000000000000000000000000000000
00700807000800007877777800007870007807000870007800007877007800700800000000000000000000000000000000000000000000000000000000000000
00700870000870007800007870007870007807000870007800070870007800000800000000000000000000000000000000000000000000000000000000000000
00700877777807770800007807770807770807000807770807700807770800700800000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
999999999006666666000aaaaaaa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
90000000906600000660a0a000a0a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
90000000906000000060aa00000aa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
90000000906000000060a0000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
90000000906000000060a0000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
90000000906000000060a0000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
90000000906000000060a0000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
90000000906000000060a0000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
90000000906000000060a0000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
90000000906000000060a0000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
90000000906000000060aa00000aa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
90000000906600000660a0a000a0a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
999999999006666666000aaaaaaa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
17100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
17710000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
17771000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
17777100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
17711000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01171000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
